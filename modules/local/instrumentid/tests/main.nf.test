nextflow_process {

  name "Test Process INSTRUMENTID"
  script "../main.nf"
  process "INSTRUMENTID"

  tag "modules"
  tag "instrumentid"

  // Real run (uses paired FASTQ files)
  test("instrumentid: paired reads") {
    when {
      process {
        """
        // Input: tuple val(meta), path(reads)
        input[0] = [
          [ id: 'toy' ],
          [
            file("${projectDir}/modules/local/instrumentid/tests/Test_1_R1.fastq.gz", checkIfExists: true),
            file("${projectDir}/modules/local/instrumentid/tests/Test_1_R2.fastq.gz", checkIfExists: true)
          ]
        ]
        """
      }
    }
    then {
      assertAll(
        { assert process.success },  // Check that the process completed successfully (exit code 0)
        // Check that the output files match the expected snapshot
        { assert snapshot([
            // These refer to the process emits
            id      : process.out.id,
            versions: process.out.versions
          ]).match() }
      )
    }
  }

  // Fast stub run
  test("instrumentid: stub") {
    options "-stub-run"
    when {
      process {
        """
        input[0] = [
          [ id: 'toy' ],
          [
            file("${projectDir}/modules/local/instrumentid/tests/Test_1_R1.fastq.gz", checkIfExists: true),
            file("${projectDir}/modules/local/instrumentid/tests/Test_1_R2.fastq.gz", checkIfExists: true)
          ]
        ]
        """
      }
    }
    then {
      assertAll(
        { assert process.success },
        { assert snapshot([
            id      : process.out.id,
            versions: process.out.versions
          ]).match() }
      )
    }
  }
}
